MACHINE = "raspberrypi0-2w"

DISTRO ?= "poky"

EXTRA_IMAGE_FEATURES ?= "debug-tweaks"
IMAGE_FEATURES:append = " ssh-server-dropbear"
IMAGE_FSTYPES += " wic.gz"

USER_CLASSES ?= "buildstats"

PATCHRESOLVE = "noop"

BB_DISKMON_DIRS ??= "\
    STOPTASKS,${TMPDIR},1G,100K \
    STOPTASKS,${DL_DIR},1G,100K \
    STOPTASKS,${SSTATE_DIR},1G,100K \
    STOPTASKS,/tmp,100M,100K \
    HALT,${TMPDIR},100M,1K \
    HALT,${DL_DIR},100M,1K \
    HALT,${SSTATE_DIR},100M,1K \
    HALT,/tmp,10M,1K"

PACKAGECONFIG:append:pn-qemu-system-native = " sdl"

CONF_VERSION = "2"

DEFAULT_TIMEZONE = "America/Sao_Paulo"
REPRODUCIBLE_MAIN_PACKAGE_STATIC_ID = "1"

BB_NUMBER_THREADS = "10"
PARALLEL_MAKE = "-j10"

DL_DIR ?= "${TOPDIR}/../build/downloads"

SSTATE_DIR ?= "${TOPDIR}/../build/sstate-cache"

DISTRO_FEATURES:append = " wifi"

# Força o Kernel 6.1 (LTS Estável para Zero 2 W)
PREFERRED_VERSION_linux-raspberrypi = "6.1.%"


# Força apenas o DTB do Zero 2 W (e variantes próximas para segurança)
KERNEL_DEVICETREE = " \
    bcm2710-rpi-zero-2.dtb \
    bcm2710-rpi-zero-2-w.dtb \
"

# --- MIGRACAO PARA SYSTEMD ---
# Define o Systemd como gerenciador de inicialização
INIT_MANAGER = "systemd"

# Adiciona feature systemd e remove sysvinit da distro
DISTRO_FEATURES:append = " systemd"
DISTRO_FEATURES_BACKFILL_CONSIDERED += "sysvinit"

# Garante que pacotes usem systemd onde possível
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = "systemd-compat-units"

SYSTEMD_AUTO_ENABLE:pn-wpa-supplicant = "enable"

LICENSE_FLAGS_ACCEPTED:append = " synaptics-killswitch commercial"

# --- HABILITAR INTERFACES DE HARDWARE --- Habilita as interfaces no firmware/config.txt
# Habilita o barramento I2C (para displays, sensores)
ENABLE_I2C = "1"
ENABLE_SPI = "1"
ENABLE_UART = "1"
ENABLE_PWM = "1"
#ENABLE_FIRMWARE_PWM = "1"

# --- HABILITAR PWM (Hardware) ---
# Força a inclusão do arquivo compilado do overlay na partição de boot
KERNEL_DEVICETREE:append = " overlays/pwm-2chan.dtbo"
IMAGE_INSTALL:append = " kernel-devicetree"

#RPI_EXTRA_CONFIG += " \n\
#dtparam=spi=on \n\
#dtparam=pwm=on \n\
#dtoverlay=pwm-2chan,pin=18,func=2,pin2=19,func2=2 \n\
#"

# Desabilita o áudio que compete pelo hardware de PWM
DT_OVERLAY_CONFIG:append = " dtparam=audio=off"

# Configuração limpa para os dois canais
RPI_EXTRA_CONFIG += " \n\
dtparam=spi=on \n\
dtparam=pwm=on \n\
dtoverlay=pwm-2chan \n\
dtparam=pin=18,func=2 \n\
dtparam=pin2=19,func2=2 \n\
"

# 3. Garante que o Kernel não tente usar o pino 18 para mais nada
# Isso ajuda a tirar o estado 'UNCLAIMED'
RPI_EXTRA_CONFIG += " \n\
gpio=18=a5 \n\
"

KERNEL_MODULE_AUTOLOAD += " pwm-bcm2835 spi-bcm2835 spidev i2c-dev i2c-bcm2835"

